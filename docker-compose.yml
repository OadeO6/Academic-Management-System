x-shared: &shared
  build:
    context: .
  dns:
    - 8.8.8.8
  volumes:
    - .:/app:z
  env_file:
    - .env
  depends_on:
    # redis:
    #   condition: service_healthy
    db:
      condition: service_healthy


services:
  db:
    image: "postgres"
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s
    volumes:
      - app-db-data:/var/lib/postgresql/data/pgdata
    env_file:
      - .env

    # ports:
    #   - 5432:5432
    network_mode: host


    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD?Variable not set}
      - POSTGRES_USER=${POSTGRES_USER?Variable not set}
      - POSTGRES_DB=${POSTGRES_DB?Variable not set}

  app:
    <<: *shared
    restart: always


    network_mode: host
    # ports:
      # - 8000:8000
      # - 8001:80
      # - 5678:5678

  prestart:
    <<: *shared
    command: bash scripts/prestart.sh


volumes:
  app-db-data:
