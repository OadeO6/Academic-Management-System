<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Academia - AI Tutor</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          "primary": "#137fec",
          "background-light": "#f6f7f8",
          "background-dark": "#101922",
          "text-light-primary": "#0d141b",
          "text-light-secondary": "#4c739a",
          "text-dark-primary": "#f6f7f8",
          "text-dark-secondary": "#a2b6c9",
          "border-light": "#e7edf3",
          "border-dark": "#1e293b",
          "surface-light": "#ffffff",
          "surface-dark": "#16222e",
        },
        fontFamily: { "display": ["Lexend", "sans-serif"] },
        borderRadius: {
          "DEFAULT": "0.25rem", "lg": "0.5rem",
          "xl": "0.75rem", "2xl": "1rem", "full": "9999px"
        },
      },
    },
  }
</script>
<style>
  .material-symbols-outlined {
    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
  }

  :root { --ease-spring: cubic-bezier(0.16, 1, 0.3, 1); }

  @keyframes fadeSlideRight {
    from { opacity: 0; transform: translateX(-24px); }
    to   { opacity: 1; transform: translateX(0); }
  }
  @keyframes fadeSlideDown {
    from { opacity: 0; transform: translateY(-14px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  @keyframes fadeSlideUp {
    from { opacity: 0; transform: translateY(18px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to   { opacity: 1; }
  }
  @keyframes scaleIn {
    from { opacity: 0; transform: scale(0.88); }
    to   { opacity: 1; transform: scale(1); }
  }
  @keyframes popIn {
    0%   { opacity: 0; transform: scale(0.82) translateY(12px); }
    70%  { transform: scale(1.03) translateY(-2px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
  }
  @keyframes avatarPop {
    0%   { transform: scale(0.5); opacity: 0; }
    70%  { transform: scale(1.12); }
    100% { transform: scale(1); opacity: 1; }
  }
  @keyframes typingBounce {
    0%, 100% { transform: translateY(0); opacity: 0.35; }
    50%       { transform: translateY(-6px); opacity: 1; }
  }
  @keyframes shimmer {
    0%   { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }
  @keyframes pulseGlow {
    0%, 100% { box-shadow: 0 0 0 0 rgba(19,127,236,0.35); }
    50%       { box-shadow: 0 0 0 7px rgba(19,127,236,0); }
  }
  @keyframes aiAvatarPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(19,127,236,0.2); }
    50%       { box-shadow: 0 0 0 5px rgba(19,127,236,0); }
  }
  @keyframes logoGlow {
    0%, 100% { filter: drop-shadow(0 0 0px rgba(19,127,236,0)); }
    50%       { filter: drop-shadow(0 0 8px rgba(19,127,236,0.7)); }
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  @keyframes chipReveal {
    from { opacity: 0; transform: translateY(8px) scale(0.94); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }
  @keyframes inputBarRise {
    from { opacity: 0; transform: translateY(22px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  @keyframes darkToggleSpin {
    from { transform: rotate(-30deg) scale(0.7); opacity: 0; }
    to   { transform: rotate(0deg) scale(1); opacity: 1; }
  }
  @keyframes msgSlideIn {
    from { opacity: 0; transform: translateY(14px) scale(0.97); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }

  html { transition: background 0.3s ease, color 0.3s ease; }

  aside { animation: fadeSlideRight 0.5s var(--ease-spring) both; }

  .sidebar-logo {
    animation: logoGlow 3s ease-in-out 1s infinite;
    cursor: pointer;
    display: inline-block;
    transition: transform 0.3s var(--ease-spring);
  }
  .sidebar-logo:hover { animation: spin 0.7s var(--ease-spring) forwards; }

  .sidebar-top-item {
    transition: background 0.18s, color 0.18s, transform 0.15s;
    animation: fadeSlideRight 0.4s var(--ease-spring) both;
  }
  .sidebar-top-item:hover { transform: translateX(3px); }

  .new-chat-btn {
    transition: background 0.18s, transform 0.14s, box-shadow 0.18s;
    animation: scaleIn 0.4s 0.1s var(--ease-spring) both;
    position: relative; overflow: hidden;
  }
  .new-chat-btn::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(120deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
    background-size: 200% 100%; opacity: 0; transition: opacity 0.2s;
  }
  .new-chat-btn:hover::before { opacity: 1; animation: shimmer 0.6s linear; }
  .new-chat-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,0.25); }
  .new-chat-btn:active { transform: scale(0.96); }

  .recent-item {
    animation: fadeSlideRight 0.4s var(--ease-spring) both;
    transition: background 0.18s, color 0.18s, transform 0.15s;
  }
  .recent-item:nth-child(1) { animation-delay: 0.18s; }
  .recent-item:nth-child(2) { animation-delay: 0.25s; }
  .recent-item:nth-child(3) { animation-delay: 0.32s; }
  .recent-item:nth-child(4) { animation-delay: 0.39s; }
  .recent-item:hover { transform: translateX(3px); }
  .recent-item.active-context { background: rgba(255,255,255,0.1); color: white; }

  .user-profile-btn {
    animation: fadeSlideUp 0.4s 0.44s var(--ease-spring) both;
    transition: background 0.18s, transform 0.15s;
  }
  .user-profile-btn:hover { transform: translateY(-1px); }

  .user-avatar-sidebar {
    animation: avatarPop 0.5s 0.5s var(--ease-spring) both;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .user-avatar-sidebar:hover { transform: scale(1.1); box-shadow: 0 0 0 3px rgba(19,127,236,0.3); }

  .main-header { animation: fadeSlideDown 0.4s 0.1s var(--ease-spring) both; }

  .header-title { transition: background 0.18s, opacity 0.18s, transform 0.15s; }
  .header-title:hover { transform: translateY(1px); }

  .header-btn { transition: background 0.18s, transform 0.15s, color 0.15s; }
  .header-btn:hover { transform: scale(1.1); }
  .header-btn:active { transform: scale(0.93); }

  .dark-toggle {
    transition: background 0.22s, transform 0.2s, box-shadow 0.2s;
  }
  .dark-toggle:hover { transform: scale(1.1); box-shadow: 0 0 0 3px rgba(19,127,236,0.2); }
  .dark-toggle:active { transform: scale(0.92); }
  .dark-toggle .icon { transition: transform 0.3s var(--ease-spring), opacity 0.2s; }

  .msg-row {
    animation: msgSlideIn 0.45s var(--ease-spring) both;
  }

  .ai-avatar {
    animation: aiAvatarPulse 3s ease-in-out 1.5s infinite;
    transition: transform 0.2s;
    flex-shrink: 0;
  }
  .msg-row:hover .ai-avatar { transform: scale(1.1); }

  .ai-bubble {
    transition: box-shadow 0.22s;
  }
  .ai-bubble:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.07); }

  .user-bubble {
    transition: box-shadow 0.2s, transform 0.18s;
  }
  .user-bubble:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,0.08); }

  .suggestion-chip {
    animation: chipReveal 0.4s var(--ease-spring) both;
    transition: background 0.18s, transform 0.15s, box-shadow 0.15s, border-color 0.18s, color 0.18s;
  }
  .suggestion-chip:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 14px rgba(0,0,0,0.09);
    border-color: #137fec;
    color: #137fec;
  }
  .suggestion-chip:active { transform: scale(0.96); }

  .typing-dot {
    width: 8px; height: 8px; border-radius: 50%;
    animation: typingBounce 1.1s ease-in-out infinite;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.18s; }
  .typing-dot:nth-child(3) { animation-delay: 0.36s; }

  .input-bar {
    animation: inputBarRise 0.55s 0.12s var(--ease-spring) both;
    transition: box-shadow 0.22s, border-color 0.22s;
  }
  .input-bar:focus-within {
    box-shadow: 0 0 0 3px rgba(19,127,236,0.15);
    border-color: #137fec !important;
  }

  .send-btn {
    transition: background 0.18s, transform 0.15s, box-shadow 0.18s, opacity 0.18s;
  }
  .send-btn:not(:disabled) { animation: pulseGlow 2.5s ease-in-out 1.5s infinite; }
  .send-btn:not(:disabled):hover { transform: scale(1.12); box-shadow: 0 4px 16px rgba(19,127,236,0.45); }
  .send-btn:active { transform: scale(0.92); }

  .attach-btn { transition: background 0.18s, transform 0.15s, color 0.15s; }
  .attach-btn:hover { transform: scale(1.1) rotate(15deg); }
  .attach-btn:active { transform: scale(0.93); }

  .share-btn { transition: background 0.18s, transform 0.15s; }
  .share-btn:hover { transform: translateY(-1px); }

  .disclaimer { animation: fadeIn 0.6s 0.45s both; }

  .scroll-btn {
    animation: fadeSlideUp 0.3s var(--ease-spring) both;
    transition: transform 0.18s, box-shadow 0.18s, opacity 0.18s;
  }
  .scroll-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,0.15); }

  .copy-btn {
    opacity: 0;
    transition: opacity 0.18s, transform 0.15s;
  }
  .msg-row:hover .copy-btn { opacity: 1; }
  .copy-btn:hover { transform: scale(1.1); }
  .copy-btn:active { transform: scale(0.93); }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 99px; }
  ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light-primary dark:text-text-dark-primary overflow-hidden transition-colors duration-300">
<div class="flex h-screen w-full">

  <aside class="flex flex-col h-full w-[280px] bg-surface-dark dark:bg-[#0d1821] border-r border-border-light dark:border-border-dark shrink-0 hidden md:flex text-text-dark-primary">
    <div class="flex flex-col p-3 pb-2 gap-2">
      <a class="sidebar-top-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-text-dark-secondary hover:text-white hover:bg-white/10 group" href="StudDASH.html">
        <span class="material-symbols-outlined text-[20px] text-text-dark-secondary group-hover:text-white transition-colors">arrow_back</span>
        <span class="text-sm font-medium">Back to Dashboard</span>
      </a>
      <button onclick="newChat()" class="new-chat-btn flex items-center gap-3 px-3 py-3 rounded-lg border border-white/20 hover:bg-white/10 text-left group">
        <span class="material-symbols-outlined text-[20px] text-white">add</span>
        <span class="text-sm font-medium text-white">New Chat</span>
      </button>
    </div>

    <div class="flex-1 overflow-y-auto px-3 py-2">
      <div class="px-3 pb-2 text-xs font-medium text-text-dark-secondary/60 uppercase tracking-wider">Recent Contexts</div>
      <div id="recent-list" class="flex flex-col gap-1">
        <div class="recent-item active-context flex items-center gap-3 px-3 py-2.5 rounded-lg cursor-pointer text-white relative overflow-hidden" onclick="switchContext('History 101', this)">
          <span class="material-symbols-outlined text-[18px]">history_edu</span>
          <div class="flex-1 truncate text-sm font-normal">History 101</div>
        </div>
        <div class="recent-item flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-white/5 cursor-pointer text-text-dark-secondary hover:text-white transition-colors" onclick="switchContext('ECE 202', this)">
          <span class="material-symbols-outlined text-[18px]">calculate</span>
          <div class="flex-1 truncate text-sm font-normal">ECE 202</div>
        </div>
        <div class="recent-item flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-white/5 cursor-pointer text-text-dark-secondary hover:text-white transition-colors" onclick="switchContext('Physics 201', this)">
          <span class="material-symbols-outlined text-[18px]">science</span>
          <div class="flex-1 truncate text-sm font-normal">Physics 201</div>
        </div>
        <div class="recent-item flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-white/5 cursor-pointer text-text-dark-secondary hover:text-white transition-colors" onclick="switchContext('Computer Engineering', this)">
          <span class="material-symbols-outlined text-[18px]">code</span>
          <div class="flex-1 truncate text-sm font-normal">Computer Engineering</div>
        </div>
      </div>
    </div>

    <div class="p-3 border-t border-white/10 mt-auto">
      <button class="user-profile-btn flex w-full items-center gap-3 px-3 py-3 rounded-lg hover:bg-white/10 text-left group">
        <div class="user-avatar-sidebar flex size-8 items-center justify-center rounded-full bg-primary/20 text-primary border border-primary/30">
          <span class="material-symbols-outlined text-[18px]">account_circle</span>
        </div>
        <div class="flex-1 min-w-0">
          <div class="text-sm font-medium text-white truncate">Student Account</div>
          <div class="text-xs text-text-dark-secondary truncate">Free Plan</div>
        </div>
        <span class="material-symbols-outlined text-text-dark-secondary group-hover:text-white text-[20px] transition-colors">settings</span>
      </button>
    </div>
  </aside>

  <main class="flex flex-col flex-1 h-screen relative bg-surface-light dark:bg-background-dark transition-colors duration-300">

    <header class="flex md:hidden items-center justify-between p-4 border-b border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark transition-colors">
      <button class="header-btn text-text-light-secondary dark:text-text-dark-secondary"><span class="material-symbols-outlined">menu</span></button>
      <span id="ctx-title-mobile" class="font-medium text-text-light-primary dark:text-text-dark-primary">History 101</span>
      <span class="material-symbols-outlined text-text-light-secondary dark:text-text-dark-secondary">add</span>
    </header>

    <header class="main-header hidden md:flex items-center justify-between px-6 py-3 shrink-0 absolute top-0 left-0 right-0 z-10 bg-surface-light/80 dark:bg-background-dark/80 backdrop-blur-sm border-b border-border-light/50 dark:border-border-dark/50 transition-colors duration-300">
      <div class="header-title flex items-center gap-2 cursor-pointer hover:bg-background-light dark:hover:bg-white/5 px-3 py-1.5 rounded-lg group">
        <span id="ctx-title" class="text-lg font-semibold text-text-light-primary dark:text-text-dark-primary opacity-80 group-hover:opacity-100 transition-all">History 101</span>
        <span class="material-symbols-outlined text-text-light-secondary text-xl">expand_more</span>
      </div>
      <div class="flex items-center gap-1">
        <button onclick="toggleDark()" id="dark-btn" class="dark-toggle p-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700" title="Toggle dark mode">
          <span id="dark-icon" class="material-symbols-outlined text-[20px] leading-none block icon">light_mode</span>
        </button>
        <button class="share-btn p-2 text-text-light-secondary hover:text-text-light-primary dark:text-text-dark-secondary dark:hover:text-text-dark-primary rounded-lg hover:bg-background-light dark:hover:bg-white/5">
          <span class="material-symbols-outlined">ios_share</span>
        </button>
      </div>
    </header>

    <div id="chat-scroll" class="flex-1 overflow-y-auto w-full scroll-smooth">
      <div class="flex flex-col h-full w-full">
        <div class="h-16 shrink-0"></div>
        <div id="msg-container" class="flex flex-col gap-8 w-full max-w-3xl mx-auto px-4 pb-36 pt-4">
        </div>
      </div>
    </div>

    <button id="scroll-btn" onclick="scrollToBottom()" class="scroll-btn hidden absolute right-6 bottom-32 size-10 bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-full shadow-lg items-center justify-center text-text-light-secondary dark:text-text-dark-secondary z-20">
      <span class="material-symbols-outlined text-xl">arrow_downward</span>
    </button>

    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-surface-light via-surface-light/95 to-transparent dark:from-background-dark dark:via-background-dark/95 pt-10 pb-6 px-4 transition-colors duration-300">
      <div class="max-w-3xl mx-auto w-full">
        <div class="input-bar relative flex items-end gap-2 w-full p-3 bg-background-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-[26px] shadow-sm">
          <button class="attach-btn p-2 ml-1 text-text-light-secondary hover:text-text-light-primary dark:text-text-dark-secondary dark:hover:text-text-dark-primary rounded-full hover:bg-black/5 dark:hover:bg-white/5">
            <span class="material-symbols-outlined">add_circle</span>
          </button>
          <textarea id="msg-input" class="w-full max-h-[200px] bg-transparent border-0 focus:ring-0 p-2.5 text-base resize-none text-text-light-primary dark:text-text-dark-primary placeholder-text-light-secondary/70 dark:placeholder-text-dark-secondary/60 leading-6" placeholder="Message Academia AI..." rows="1"></textarea>
          <button id="send-btn" onclick="sendMessage()" class="send-btn p-2 mb-0.5 rounded-xl bg-primary text-white shadow-sm disabled:opacity-40 disabled:cursor-not-allowed" disabled>
            <span class="material-symbols-outlined text-[20px] leading-none block">arrow_upward</span>
          </button>
        </div>
        <p class="disclaimer text-[11px] text-center text-text-light-secondary/70 dark:text-text-dark-secondary/50 mt-2.5">
          Academia AI uses flagged course materials. Always verify critical information.
        </p>
      </div>
    </div>
  </main>
</div>

<script>
  const AI_RESPONSES = {
    default: [
      "That's a great question! Let me break that down for you.\n\nThis topic covers several important concepts that are fundamental to the subject. The key ideas involve understanding the underlying principles and how they apply in different contexts.\n\nWould you like me to go deeper on any specific aspect?",
      "Excellent question. Here's a clear explanation:\n\nThe concept you're asking about has both theoretical foundations and practical applications. In theory, we consider the core principles and how they interact. In practice, engineers and scientists apply these principles to solve real-world problems.\n\nDo you want me to provide some examples or practice questions?",
      "Great topic to explore! Let me give you a structured answer.\n\nFirst, we should consider the background context. Second, examine the core mechanism at play. Finally, understand the implications and applications.\n\nWould you like to test your understanding with a quick quiz?",
    ],
    "can AI replace": "That's a fascinating question about AI in communication systems!\n\n**Short answer:** Not entirely — but AI is transforming the field dramatically.\n\n**Traditional techniques** like AM, FM, QAM, and OFDM are mathematically proven, predictable, and deeply embedded in existing hardware standards (LTE, 5G, Wi-Fi).\n\n**What AI can do:**\n- Learn optimal modulation schemes adaptively for a given channel\n- Perform end-to-end learned communication (autoencoders)\n- Improve equalization and signal detection in noisy environments\n\n**What AI can't easily replace:**\n- Real-time hardware-level constraints\n- Regulatory spectrum standards\n- Interpretability required for safety-critical systems\n\nResearch like DeepMind's and NVIDIA's work on AI radio shows promise, but full replacement remains a long-term challenge. For now, **AI augments rather than replaces** traditional techniques.\n\nWould you like to explore learned communication systems or autoencoder-based modems next?",
    "summarize": "Here's a concise summary of Chapter 5:\n\n**Key Themes:**\n1. Core theoretical framework and foundational definitions\n2. Mathematical models and their derivations\n3. Practical applications and engineering trade-offs\n4. Common pitfalls and how to avoid them\n\n**Important Formulas to Remember:**\n- Primary equation relating input to output\n- Efficiency and performance metrics\n- Boundary conditions and special cases\n\n**Exam Tips:** Focus on the relationship between theory and application. Professors often ask you to derive from first principles.\n\nWould you like flashcards or practice problems for this chapter?",
    "explain": "Let me explain that clearly!\n\nThe concept involves several layers of understanding:\n\n**Level 1 — Intuition:** Think of it like a simple everyday analogy that makes the abstract concrete and easy to grasp.\n\n**Level 2 — Theory:** The formal definition involves specific conditions and mathematical relationships that define the behavior precisely.\n\n**Level 3 — Application:** Engineers apply this in real systems by taking the theoretical model and adapting it to constraints like noise, bandwidth, and cost.\n\n**Quick Check:** Can you think of where you've seen this concept in your coursework or everyday life?\n\nLet me know if you'd like worked examples or a deeper dive into the math!",
    "cold war": "Here's an analysis of the causes of the Cold War:\n\n**Ideological Divide:**\nThe US championed liberal democracy and capitalism, while the USSR promoted communism and state ownership. These fundamentally incompatible worldviews created inherent tension.\n\n**Post-WWII Power Vacuum:**\nWith European powers weakened, both superpowers rushed to fill the geopolitical void, leading to competing spheres of influence.\n\n**Key Triggering Events:**\n- 1945: Yalta and Potsdam Conferences — disagreements over post-war Europe\n- 1946: Churchill's 'Iron Curtain' speech\n- 1947: Truman Doctrine — US commits to containing communism\n- 1947: Marshall Plan — economic aid as geopolitical strategy\n\n**Mutual Distrust:**\nThe USSR feared Western encirclement; the West feared communist expansion. This security dilemma drove an arms race and proxy conflicts worldwide.\n\nWould you like to explore a specific phase of the Cold War or its impact on specific regions?",
  };

  const SUGGESTIONS = {
    "History 101": ["Explain the causes of the Cold War", "Summarize Chapter 5", "What were the key events of WWII?"],
    "ECE 202": ["Explain Fourier transforms", "Summarize signal sampling theory", "What is the Nyquist theorem?"],
    "Physics 201": ["Explain quantum entanglement", "Summarize wave-particle duality", "What is Heisenberg's uncertainty principle?"],
    "Computer Engineering": ["Explain pipelining in CPUs", "What is cache coherence?", "Summarize Von Neumann architecture"],
  };

  let currentContext = "History 101";
  let isTyping = false;
  let isDark = false;
  let chatHistories = { "History 101": [], "ECE 202": [], "Physics 201": [], "Computer Engineering": [] };

  const msgContainer = document.getElementById('msg-container');
  const msgInput = document.getElementById('msg-input');
  const sendBtn = document.getElementById('send-btn');
  const chatScroll = document.getElementById('chat-scroll');
  const scrollBtn = document.getElementById('scroll-btn');

  function toggleDark() {
    isDark = !isDark;
    document.documentElement.classList.toggle('dark', isDark);
    const icon = document.getElementById('dark-icon');
    icon.style.animation = 'darkToggleSpin 0.35s var(--ease-spring) both';
    setTimeout(() => icon.style.animation = '', 400);
    icon.textContent = isDark ? 'dark_mode' : 'light_mode';
  }

  function getAIResponse(text) {
    const t = text.toLowerCase();
    if (t.includes('can ai replace') || t.includes('modulation') || t.includes('demodulation')) return AI_RESPONSES['can AI replace'];
    if (t.includes('summarize') || t.includes('summary') || t.includes('chapter')) return AI_RESPONSES['summarize'];
    if (t.includes('explain') || t.includes('what is') || t.includes('how does')) return AI_RESPONSES['explain'];
    if (t.includes('cold war') || t.includes('history') || t.includes('causes')) return AI_RESPONSES['cold war'];
    const arr = AI_RESPONSES.default;
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function makeAIAvatar() {
    return `<div class="ai-avatar flex size-8 rounded-full items-center justify-center bg-primary/15 text-primary border border-primary/25 flex-shrink-0">
      <span class="material-symbols-outlined text-[16px]">school</span>
    </div>`;
  }

  function formatText(text) {
    return text
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\n\n/g, '</p><p class="mt-3">')
      .replace(/\n- /g, '<br>• ')
      .replace(/\n(\d+\. )/g, '<br>$1')
      .replace(/\n/g, '<br>');
  }

  function appendAIMessage(text, showSuggestions = false) {
    const div = document.createElement('div');
    div.className = 'msg-row flex gap-4 md:gap-6 w-full group';
    div.style.animationDelay = '0ms';
    const chips = showSuggestions
      ? `<div class="flex flex-wrap gap-2 mt-4" id="chips-area">
          ${(SUGGESTIONS[currentContext] || []).map(s =>
            `<button class="suggestion-chip text-xs font-medium text-text-light-secondary dark:text-text-dark-secondary border border-border-light dark:border-border-dark rounded-xl px-3 py-2 hover:bg-background-light dark:hover:bg-white/5" onclick="useSuggestion(this)">${s}</button>`
          ).join('')}
        </div>` : '';

    div.innerHTML = `
      ${makeAIAvatar()}
      <div class="relative flex-1 min-w-0">
        <div class="flex items-center gap-2 mb-1">
          <span class="font-semibold text-sm text-text-light-primary dark:text-text-dark-primary">Academia AI</span>
          <span class="text-[10px] text-text-light-secondary/50 dark:text-text-dark-secondary/40">${getTime()}</span>
        </div>
        <div class="ai-bubble prose max-w-none text-text-light-primary dark:text-text-dark-primary text-[15px] leading-7">
          <p>${formatText(text)}</p>
        </div>
        ${chips}
        <button class="copy-btn mt-2 flex items-center gap-1 text-xs text-text-light-secondary dark:text-text-dark-secondary hover:text-primary rounded-lg px-2 py-1 hover:bg-background-light dark:hover:bg-white/5" onclick="copyText(this, ${JSON.stringify(text)})">
          <span class="material-symbols-outlined text-[14px]">content_copy</span> Copy
        </button>
      </div>`;
    msgContainer.appendChild(div);
    scrollToBottom();
  }

  function appendUserMessage(text) {
    const div = document.createElement('div');
    div.className = 'msg-row flex gap-4 md:gap-6 w-full flex-row-reverse group';
    div.innerHTML = `
      <div class="relative max-w-[85%]">
        <div class="user-bubble bg-primary/10 dark:bg-primary/15 text-text-light-primary dark:text-text-dark-primary px-5 py-3 rounded-2xl rounded-tr-sm border border-primary/20">
          <p class="text-[15px] leading-7">${escapeHTML(text)}</p>
        </div>
        <div class="flex justify-end mt-1">
          <span class="text-[10px] text-text-light-secondary/50 dark:text-text-dark-secondary/40">${getTime()}</span>
        </div>
      </div>`;
    msgContainer.appendChild(div);
    scrollToBottom();
  }

  function appendTypingIndicator() {
    const div = document.createElement('div');
    div.id = 'typing-indicator';
    div.className = 'msg-row flex gap-4 md:gap-6 w-full group';
    div.innerHTML = `
      ${makeAIAvatar()}
      <div class="relative flex-1 min-w-0">
        <div class="font-semibold text-sm text-text-light-primary dark:text-text-dark-primary mb-2">Academia AI</div>
        <div class="flex items-center gap-1.5 px-4 py-3 bg-background-light dark:bg-surface-dark rounded-2xl rounded-tl-sm w-fit border border-border-light dark:border-border-dark">
          <div class="typing-dot bg-text-light-secondary/50 dark:bg-text-dark-secondary/50"></div>
          <div class="typing-dot bg-text-light-secondary/50 dark:bg-text-dark-secondary/50"></div>
          <div class="typing-dot bg-text-light-secondary/50 dark:bg-text-dark-secondary/50"></div>
        </div>
      </div>`;
    msgContainer.appendChild(div);
    scrollToBottom();
    return div;
  }

  function removeTyping() {
    const t = document.getElementById('typing-indicator');
    if (t) t.remove();
  }

  function sendMessage(text) {
    const raw = text || msgInput.value.trim();
    if (!raw || isTyping) return;

    appendUserMessage(raw);
    msgInput.value = '';
    msgInput.style.height = 'auto';
    sendBtn.disabled = true;
    isTyping = true;

    const typingEl = appendTypingIndicator();
    const delay = 1200 + Math.random() * 1200;

    setTimeout(() => {
      removeTyping();
      const response = getAIResponse(raw);
      appendAIMessage(response);
      isTyping = false;
      updateSendBtn();
    }, delay);
  }

  function useSuggestion(btn) {
    const text = btn.textContent;
    document.getElementById('chips-area')?.remove();
    sendMessage(text);
  }

  function newChat() {
    chatHistories[currentContext] = [];
    msgContainer.innerHTML = '';
    appendWelcome();
  }

  function switchContext(ctx, el) {
    currentContext = ctx;
    document.getElementById('ctx-title').textContent = ctx;
    document.getElementById('ctx-title-mobile').textContent = ctx;
    document.querySelectorAll('.recent-item').forEach(i => {
      i.classList.remove('active-context', 'text-white', 'bg-white/10');
      i.classList.add('text-text-dark-secondary');
    });
    el.classList.add('active-context', 'text-white');
    el.classList.remove('text-text-dark-secondary');
    msgContainer.innerHTML = '';
    appendWelcome();
  }

  function appendWelcome() {
    appendAIMessage(
      `Hello! I'm the Academia AI Tutor for **${currentContext}**. How can I help you today? You can ask me to explain a concept, summarize a chapter, or help with study questions.`,
      true
    );
  }

  function scrollToBottom() {
    setTimeout(() => chatScroll.scrollTo({ top: chatScroll.scrollHeight, behavior: 'smooth' }), 50);
  }

  function updateSendBtn() {
    sendBtn.disabled = msgInput.value.trim().length === 0 || isTyping;
  }

  function getTime() {
    return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function escapeHTML(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function copyText(btn, text) {
    navigator.clipboard?.writeText(text).catch(() => {});
    btn.innerHTML = '<span class="material-symbols-outlined text-[14px]">check</span> Copied!';
    btn.classList.add('text-primary');
    setTimeout(() => {
      btn.innerHTML = '<span class="material-symbols-outlined text-[14px]">content_copy</span> Copy';
      btn.classList.remove('text-primary');
    }, 1800);
  }

  msgInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    updateSendBtn();
  });

  msgInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (!sendBtn.disabled) sendMessage();
    }
  });

  chatScroll.addEventListener('scroll', () => {
    const nearBottom = chatScroll.scrollHeight - chatScroll.scrollTop - chatScroll.clientHeight < 120;
    scrollBtn.classList.toggle('hidden', nearBottom);
    scrollBtn.classList.toggle('flex', !nearBottom);
  });

  appendWelcome();
</script>
</body>
</html>